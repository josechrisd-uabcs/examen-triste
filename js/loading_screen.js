import { load_assets } from "./asset_loader.js";
import { Entity } from "./engine.js";
import { HomeScreen } from "./game.js";
import { min } from "./utils.js";

export class LoadingScreen extends Entity {
    constructor(){
        super();
        const path= new Path2D("m 23.009302,244.58853 c 4.372593,-2.82923 8.60585,-5.91473 13.630767,-8.15011 -2.724075,0.001 -5.415144,-0.42644 -8.220984,0.63783 -1.39439,0.31459 -3.279888,2.61446 -3.77976,2.57496 -0.295035,-0.0539 -0.266631,-0.62926 -0.755953,-0.51971 -0.942625,0.26017 -1.627391,1.23661 -2.385975,2.008 -1.223596,0.44008 -2.456385,1.03184 -3.638021,0.77957 -0.878498,-0.10498 -1.692252,-0.10818 -2.22061,-1.08668 l 0.722879,-0.69926 c 0.165511,-0.15031 0.169627,-0.30958 -0.06142,-0.48192 -0.238031,-0.18536 1.727747,-1.27799 2.598587,-1.9135 l 1.252046,-0.23624 4.701079,-2.45684 3.42541,-0.96857 5.433406,-1.9135 4.464847,-2.55134 c -2.545392,-2.57135 -3.712766,-5.54278 -4.913691,-8.50446 l -4.181364,-2.52772 c -2.238315,-0.14229 -4.766298,1.09134 -6.685453,-0.56696 L 20.43434,216.4293 c -2.484838,-2.11398 -0.755952,-2.59858 -0.755952,-2.59858 l 0.992187,-0.42523 4.960938,-2.3151 4.582962,-4.20499 0.07087,-5.2208 c 0.0042,-0.67363 0.512883,-0.7334 0.732327,-0.3071 l 1.015813,2.12611 0.710181,-3.1375 c 0.04069,-0.16513 0.347964,-0.25466 0.496094,-0.0236 l 1.604923,2.52329 c 0,0 7.049818,9.46586 27.095033,11.80446 20.045216,2.33861 17.305704,2.40543 21.78247,1.87089 4.476764,-0.53454 3.875408,-1.80407 8.084903,-1.87089 4.209494,-0.0668 6.481286,0.80181 9.087161,1.80407 2.60588,1.00226 2.87315,2.40543 10.15625,2.93997 7.28309,0.53454 6.34765,-0.20045 8.41899,-0.33409 2.07134,-0.13363 5.54584,0.60136 5.81311,1.00226 0.26727,0.40091 -5.34539,6.88219 -11.22532,7.2831 -5.87993,0.4009 -13.36348,-4.87767 -13.36348,-4.87767 0,0 3.00678,7.21628 4.6104,8.81989 1.60362,1.60362 3.81281,2.15046 3.81281,2.15046 0,0 0.87407,0.21261 2.10249,0.14174 1.22842,-0.0709 2.50409,1.67727 3.47266,2.62221 0.96856,0.94494 0.73233,1.48828 2.36235,2.45684 1.63002,0.96857 3.44903,1.08668 3.87425,1.01581 0.42523,-0.0709 0.54335,0.44885 0.25987,0.75596 -0.28349,0.3071 0.14174,0.44884 0.63783,0.56696 0.49609,0.11812 1.39379,-0.30711 2.29148,-0.18899 0.89769,0.11812 2.03162,0.42523 2.62221,1.03944 0.59059,0.61421 1.41741,1.63002 0.82682,2.07887 -0.59058,0.44884 -0.92131,-0.14175 -1.74814,0.42522 -0.82682,0.56696 -12.68582,-4.15774 -12.85119,-4.03962 -0.16536,0.11812 4.016,5.95312 5.33892,6.56733 1.32291,0.61422 2.85844,0.96857 2.85844,0.96857 0,0 0.16537,0 0.18899,0.25986 0.0236,0.25986 -0.25986,0.14174 -0.23624,0.4016 0.0236,0.25986 1.27567,-0.0709 2.26786,0.0945 0.99219,0.16537 2.57496,2.19699 2.71671,2.55134 0.14174,0.35435 -0.21262,0.59059 -0.4961,0.63784 -0.28348,0.0472 -0.89769,0.0472 -1.13393,0.33072 -0.23623,0.28349 -1.06306,0.92132 -2.26786,0.35436 -1.20479,-0.56697 -10.68621,-6.9589 -11.92233,-8.62934 -1.23613,-1.67043 -2.80634,-2.10474 -2.80634,-2.10474 l -3.17795,-1.07768 c 0,0 -5.174216,0.84381 -9.550756,-1.69525 -4.376539,-2.53906 -6.848782,-6.11379 -7.216278,-6.18061 -0.367496,-0.0668 -6.313136,7.3089 -20.72348,5.37177 -14.410342,-1.93713 -15.827754,-3.07106 -15.827754,-3.07106 0,0 -7.1343,2.88207 -7.748512,3.35454 -0.614211,0.47247 -1.41741,1.55915 -2.078868,1.93713 -0.661459,0.37797 -2.504094,0.0473 -3.685271,0.37797 -1.181174,0.33073 -9.260417,3.73252 -9.874628,4.20499 -0.61421,0.47247 -0.61421,1.46466 -0.61421,1.46466 0,0 -0.566964,0.63781 -1.21661,0.70868 -0.649647,0.0709 -0.649647,-0.48428 -0.578777,-0.63784 0.07087,-0.15355 -1.81901,0.86226 -2.149739,1.13393 -0.330729,0.27167 -1.370164,1.33473 -1.996187,1.51191 -0.626023,0.17717 -1.252046,0.0945 -1.464658,0.0591 -0.212612,-0.0354 -0.318917,-0.28349 -0.614211,-0.31892 -0.295294,-0.0354 -1.216611,0.15355 -1.299294,-0.28348 -0.08268,-0.43704 -0.03543,-0.72052 0.425224,-1.18118 0.460658,-0.46066 0.531529,-0.3071 0.696893,-0.55515 0.165365,-0.24805 0.460659,-1.15755 1.263858,-1.35835 0.8032,-0.2008 2.515904,-0.62603 2.704893,-0.74414 0.188988,-0.11812 0.259858,-0.17718 0.259858,-0.17718 z");
        const m = document.createElementNS("http://www.w3.org/2000/svg", "svg").createSVGMatrix()
        this.canisLogo = new Path2D()
        let t = m.scale(317/176.38911 * 1.5)
        t = t.translate(19,-100)
        this.canisLogo.addPath(path, t)

        this.bar_size = [
            250, 20
        ]

        this.bar_y = 480;
        this.bar_padding = 3;

        this.load = 0;
        this.timer = 0;
    }
    
    init(game) {

    }

    update(game) {
        if(this.timer !== null){
            this.timer += game.deltaTime;
            if(this.timer > .5){
                this.timer = null;
                load_assets(({
                    assets_loaded,
                    assets_failed,
                    assets_to_load,
                }) => {
                    this.load = (assets_loaded + assets_failed) / assets_to_load;
                    if(assets_loaded + assets_failed == assets_to_load){
                        game.removeEntity(this);
                        game.addEntity(new HomeScreen());
                    }
                })
            }
        }
    }

    draw(ctx, size) {
        ctx.strokeStyle = ctx.fillStyle = "#67b1ffff";
        ctx.fillRect(0,0, ...size);
        ctx.strokeStyle = ctx.fillStyle = "#fff";
        ctx.fill(this.canisLogo);
        ctx.lineWidth = "2px";
        const pos_x = (size[0] - this.bar_size[0]) / 2;
        ctx.strokeRect(pos_x, this.bar_y, ...this.bar_size);
        ctx.fillRect(pos_x + this.bar_padding, this.bar_y + this.bar_padding, (this.bar_size[0] - this.bar_padding * 2) * min(this.load, 1), this.bar_size[1] - this.bar_padding * 2);
    }
}